<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - Manage Sensors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .container {
            margin-top: 30px;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid var(--bs-border-color);
        }
        .content-section {
            position: relative;
            overflow: hidden;
            background: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }
        .content-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #198754, #20c997);
        }
        .sensor-enabled {
            background-color: rgba(25, 135, 84, 0.1);
            border-color: rgba(25, 135, 84, 0.3);
            border-radius: 8px;
            color: var(--bs-body-color);
        }
        .sensor-disabled {
            background-color: rgba(25, 135, 84, 0.05);
            border-color: rgba(25, 135, 84, 0.2);
            border-radius: 8px;
            color: var(--bs-body-color);
        }
        .btn-toggle {
            min-width: 120px;
        }
        .btn-green {
            background: linear-gradient(135deg, #198754, #20c997);
            border: none;
            color: white;
        }
        .btn-green:hover {
            background: linear-gradient(135deg, #157347, #1aa179);
            color: white;
        }
        .sensor-types-section {
            background-color: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        .sensor-type-checkbox {
            margin-right: 15px;
            margin-bottom: 8px;
        }
        .entry-type-card {
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        .entry-type-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .alert-section {
            background: rgba(25, 135, 84, 0.1);
            border: 1px solid rgba(25, 135, 84, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: var(--bs-body-color);
        }
        .btn-spacing {
            margin-left: 1rem;
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                padding: 20px;
            }
            .header-actions {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .btn-spacing {
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1 class="mb-0">{{ project_name }} Sensors</h1>
            </div>
            <div class="header-actions d-flex align-items-center">
                                <a href="{{ url_for('maintenance.maintenance_module_page') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Settings
                </a>
            </div>
        </div>

        <div class="alert-section">
            <div class="d-flex align-items-start">
                <i class="fas fa-info-circle text-success me-3 mt-1"></i>
                <div>
                    <strong>About Sensor Data:</strong> When enabled for an entry type, users can record and track sensor measurements. 
                    Sensor types are automatically discovered when devices are added to the system. 
                    This is useful for monitoring physical objects, locations, or equipment.
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-success">
                    <i class="fas fa-microchip me-2"></i>{{ entry_plural_label }} Types - Sensor Configuration
                </h5>
            </div>
            <div id="loadingMessage" class="text-center text-muted">
                <i class="fas fa-spinner fa-spin me-2"></i> Loading entry types...
            </div>
            <div id="entryTypesContainer" style="display: none;">
                <!-- Entry types will be loaded here -->
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let entryTypes = [];
        let availableSensorTypes = [];
        const manageSensorTypesUrl = "{{ manage_sensor_types_url }}";

        // DOM Elements
        const loadingMessage = document.getElementById('loadingMessage');
        const entryTypesContainer = document.getElementById('entryTypesContainer');
        const alertContainer = document.getElementById('alertContainer');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // Load both entry types and available sensor types
        async function loadData() {
            try {
                // Load entry types and system parameters in parallel
                const [entryTypesResponse, systemParamsResponse] = await Promise.all([
                    fetch('/api/entry_types'),
                    fetch('/api/system_params')
                ]);

                if (!entryTypesResponse.ok || !systemParamsResponse.ok) {
                    throw new Error('Failed to load data');
                }

                entryTypes = await entryTypesResponse.json();
                const systemParams = await systemParamsResponse.json();
                
                // Parse available sensor types
                const sensorTypesString = systemParams.sensor_types || '';
                availableSensorTypes = sensorTypesString.split(',').map(type => type.trim()).filter(type => type !== '');
                
                renderEntryTypes();
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading data: ' + error.message, 'danger');
            } finally {
                loadingMessage.style.display = 'none';
                entryTypesContainer.style.display = 'block';
            }
        }

        // Render entry types with sensor configuration
        function renderEntryTypes() {
            if (entryTypes.length === 0) {
                entryTypesContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <p>No entry types found. <a href="{{ url_for('maintenance.manage_entry_types_page') }}">Create some entry types first</a>.</p>
                    </div>
                `;
                return;
            }

            const html = entryTypes.map(entryType => {
                const enabledSensorTypes = entryType.enabled_sensor_types ? entryType.enabled_sensor_types.split(',').map(type => type.trim()).filter(type => type !== '') : [];
                
                const sensorTypesCheckboxes = availableSensorTypes.map(sensorType => {
                    const isChecked = enabledSensorTypes.includes(sensorType);
                    return `
                        <div class="form-check form-check-inline sensor-type-checkbox">
                            <input class="form-check-input" type="checkbox" id="sensor_${entryType.id}_${sensorType}" 
                                   value="${sensorType}" ${isChecked ? 'checked' : ''} 
                                   ${!entryType.has_sensors ? 'disabled' : ''}
                                   onchange="updateSensorTypes(${entryType.id})">
                            <label class="form-check-label" for="sensor_${entryType.id}_${sensorType}">
                                ${sensorType}
                            </label>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="card entry-type-card ${entryType.has_sensors ? 'sensor-enabled' : 'sensor-disabled'}">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-1">${entryType.singular_label}</h5>
                                    <small class="text-muted"><strong>Name:</strong> ${entryType.name}</small><br>
                                    <small class="text-muted"><strong>Description:</strong> ${entryType.description || 'No description'}</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-thermometer-half me-2 ${entryType.has_sensors ? 'text-success' : 'text-muted'}"></i>
                                        <span class="badge ${entryType.has_sensors ? 'bg-success' : 'bg-secondary'}">
                                            ${entryType.has_sensors ? 'Sensors Enabled' : 'Sensors Disabled'}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button class="btn btn-sm ${entryType.has_sensors ? 'btn-warning' : 'btn-success'} btn-toggle" 
                                            onclick="toggleSensors(${entryType.id}, ${!entryType.has_sensors})"
                                            data-entry-type-id="${entryType.id}">
                                        <i class="fas ${entryType.has_sensors ? 'fa-times' : 'fa-check'} me-1"></i>
                                        ${entryType.has_sensors ? 'Disable' : 'Enable'}
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${entryType.has_sensors ? `
                            <div class="card-body">
                                <h6><i class="fas fa-list me-1"></i> Available Sensor Types:</h6>
                                <div class="sensor-types-section">
                                    ${sensorTypesCheckboxes}
                                    ${availableSensorTypes.length === 0 ? '<p class="text-muted mb-0"><i class="fas fa-robot me-1"></i> No sensor types discovered yet. <a href="' + manageSensorTypesUrl + '">Add devices or manually create sensor types</a>.</p>' : ''}
                                </div>
                                <small class="text-muted">Select which sensor types will be available when adding sensor data to entries of this type.</small>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            entryTypesContainer.innerHTML = html;
        }

        // Update sensor types for an entry type
        async function updateSensorTypes(entryTypeId) {
            const checkboxes = document.querySelectorAll(`input[id^="sensor_${entryTypeId}_"]`);
            const selectedSensorTypes = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedSensorTypes.push(checkbox.value);
                }
            });

            try {
                const response = await fetch(`/api/entry_types/${entryTypeId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled_sensor_types: selectedSensorTypes.join(',')
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                // Update local data
                const entryType = entryTypes.find(et => et.id === entryTypeId);
                if (entryType) {
                    entryType.enabled_sensor_types = selectedSensorTypes.join(',');
                }

                showAlert('Sensor types updated successfully!', 'success');

            } catch (error) {
                console.error('Error updating sensor types:', error);
                showAlert('Error updating sensor types: ' + error.message, 'danger');
                // Reload the page to reset checkboxes to correct state
                loadData();
            }
        }

        // Toggle sensors for an entry type
        async function toggleSensors(entryTypeId, enable) {
            const button = document.querySelector(`button[data-entry-type-id="${entryTypeId}"]`);
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Updating...';

                const response = await fetch(`/api/entry_types/${entryTypeId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        has_sensors: enable
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showAlert(result.message, 'success');
                
                // Reload the data to reflect changes
                await loadData();

            } catch (error) {
                console.error('Error updating sensor settings:', error);
                showAlert('Error updating sensor settings: ' + error.message, 'danger');
                
                // Restore button
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Show alert message
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;

            // Auto-dismiss success alerts
            if (type === 'success') {
                setTimeout(() => {
                    const alert = alertContainer.querySelector('.alert');
                    if (alert) {
                        alert.remove();
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html>
