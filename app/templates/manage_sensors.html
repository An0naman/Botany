<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - Manage Sensors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 30px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .sensor-enabled {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .sensor-disabled {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .btn-toggle {
            min-width: 120px;
        }
        .sensor-types-section {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
        }
        .sensor-type-checkbox {
            margin-right: 15px;
            margin-bottom: 8px;
        }
        .entry-type-card {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Manage Sensors for {{ project_name }}</h1>
            <a href="{{ url_for('maintenance.maintenance_module_page') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Maintenance
            </a>
        </div>

        <p class="lead mb-4">Configure which {{ entry_plural_label }} types support sensor data collection.</p>

        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>About Sensor Data:</strong> When enabled for an entry type, users can record and track sensor measurements 
            (temperature, humidity, pressure, etc.) for entries of that type. This is useful for monitoring physical objects, 
            locations, or equipment.
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">{{ entry_plural_label }} Types - Sensor Configuration</h3>
            </div>
            <div class="card-body">
                <div id="loadingMessage" class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin me-2"></i> Loading entry types...
                </div>
                <div id="entryTypesContainer" style="display: none;">
                    <!-- Entry types will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let entryTypes = [];
        let availableSensorTypes = [];
        const manageSensorTypesUrl = "{{ manage_sensor_types_url }}";

        // DOM Elements
        const loadingMessage = document.getElementById('loadingMessage');
        const entryTypesContainer = document.getElementById('entryTypesContainer');
        const alertContainer = document.getElementById('alertContainer');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // Load both entry types and available sensor types
        async function loadData() {
            try {
                // Load entry types and system parameters in parallel
                const [entryTypesResponse, systemParamsResponse] = await Promise.all([
                    fetch('/api/entry_types'),
                    fetch('/api/system_parameters')
                ]);

                if (!entryTypesResponse.ok || !systemParamsResponse.ok) {
                    throw new Error('Failed to load data');
                }

                entryTypes = await entryTypesResponse.json();
                const systemParams = await systemParamsResponse.json();
                
                // Parse available sensor types
                const sensorTypesString = systemParams.sensor_types || 'Temperature,Humidity,Pressure';
                availableSensorTypes = sensorTypesString.split(',').map(type => type.trim()).filter(type => type !== '');
                
                renderEntryTypes();
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading data: ' + error.message, 'danger');
            } finally {
                loadingMessage.style.display = 'none';
                entryTypesContainer.style.display = 'block';
            }
        }

        // Render entry types with sensor configuration
        function renderEntryTypes() {
            if (entryTypes.length === 0) {
                entryTypesContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <p>No entry types found. <a href="{{ url_for('maintenance.manage_entry_types_page') }}">Create some entry types first</a>.</p>
                    </div>
                `;
                return;
            }

            const html = entryTypes.map(entryType => {
                const enabledSensorTypes = entryType.enabled_sensor_types ? entryType.enabled_sensor_types.split(',').map(type => type.trim()).filter(type => type !== '') : [];
                
                const sensorTypesCheckboxes = availableSensorTypes.map(sensorType => {
                    const isChecked = enabledSensorTypes.includes(sensorType);
                    return `
                        <div class="form-check form-check-inline sensor-type-checkbox">
                            <input class="form-check-input" type="checkbox" id="sensor_${entryType.id}_${sensorType}" 
                                   value="${sensorType}" ${isChecked ? 'checked' : ''} 
                                   ${!entryType.has_sensors ? 'disabled' : ''}
                                   onchange="updateSensorTypes(${entryType.id})">
                            <label class="form-check-label" for="sensor_${entryType.id}_${sensorType}">
                                ${sensorType}
                            </label>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="card entry-type-card ${entryType.has_sensors ? 'sensor-enabled' : 'sensor-disabled'}">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-1">${entryType.singular_label}</h5>
                                    <small class="text-muted"><strong>Name:</strong> ${entryType.name}</small><br>
                                    <small class="text-muted"><strong>Description:</strong> ${entryType.description || 'No description'}</small>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-thermometer-half me-2 ${entryType.has_sensors ? 'text-success' : 'text-muted'}"></i>
                                        <span class="badge ${entryType.has_sensors ? 'bg-success' : 'bg-secondary'}">
                                            ${entryType.has_sensors ? 'Sensors Enabled' : 'Sensors Disabled'}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button class="btn btn-sm ${entryType.has_sensors ? 'btn-warning' : 'btn-success'} btn-toggle" 
                                            onclick="toggleSensors(${entryType.id}, ${!entryType.has_sensors})"
                                            data-entry-type-id="${entryType.id}">
                                        <i class="fas ${entryType.has_sensors ? 'fa-times' : 'fa-check'} me-1"></i>
                                        ${entryType.has_sensors ? 'Disable' : 'Enable'}
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${entryType.has_sensors ? `
                            <div class="card-body">
                                <h6><i class="fas fa-list me-1"></i> Available Sensor Types:</h6>
                                <div class="sensor-types-section">
                                    ${sensorTypesCheckboxes}
                                    ${availableSensorTypes.length === 0 ? '<p class="text-muted mb-0">No sensor types configured. <a href="' + manageSensorTypesUrl + '">Add some sensor types first</a>.</p>' : ''}
                                </div>
                                <small class="text-muted">Select which sensor types will be available when adding sensor data to entries of this type.</small>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            entryTypesContainer.innerHTML = html;
        }

        // Update sensor types for an entry type
        async function updateSensorTypes(entryTypeId) {
            const checkboxes = document.querySelectorAll(`input[id^="sensor_${entryTypeId}_"]`);
            const selectedSensorTypes = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedSensorTypes.push(checkbox.value);
                }
            });

            try {
                const response = await fetch(`/api/entry_types/${entryTypeId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled_sensor_types: selectedSensorTypes.join(',')
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                // Update local data
                const entryType = entryTypes.find(et => et.id === entryTypeId);
                if (entryType) {
                    entryType.enabled_sensor_types = selectedSensorTypes.join(',');
                }

                showAlert('Sensor types updated successfully!', 'success');

            } catch (error) {
                console.error('Error updating sensor types:', error);
                showAlert('Error updating sensor types: ' + error.message, 'danger');
                // Reload the page to reset checkboxes to correct state
                loadData();
            }
        }

        // Toggle sensors for an entry type
        async function toggleSensors(entryTypeId, enable) {
            const button = document.querySelector(`button[data-entry-type-id="${entryTypeId}"]`);
            const originalText = button.innerHTML;
            
            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Updating...';

                const response = await fetch(`/api/entry_types/${entryTypeId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        has_sensors: enable
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showAlert(result.message, 'success');
                
                // Reload the data to reflect changes
                await loadData();

            } catch (error) {
                console.error('Error updating sensor settings:', error);
                showAlert('Error updating sensor settings: ' + error.message, 'danger');
                
                // Restore button
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Show alert message
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;

            // Auto-dismiss success alerts
            if (type === 'success') {
                setTimeout(() => {
                    const alert = alertContainer.querySelector('.alert');
                    if (alert) {
                        alert.remove();
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html>
