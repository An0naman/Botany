<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if theme_settings.dark_mode_enabled else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - System Parameters</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='mobile.css') }}">
    
    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
        }
        .container {
            margin-top: 30px;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid var(--bs-border-color);
        }
        .settings-section {
            margin-bottom: 2rem;
        }
        .section-card {
            background: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #6f42c1, #d63384);
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #6f42c1;
        }
        .form-control, .form-select {
            margin-bottom: 15px;
        }
        .preview-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bs-body-bg);
        }
        .logo-preview {
            max-width: 150px;
            max-height: 150px;
        }
        .btn-purple {
            background: linear-gradient(135deg, #6f42c1, #d63384);
            border: none;
            color: white;
        }
        .btn-purple:hover {
            background: linear-gradient(135deg, #5a359a, #b02a5b);
            color: white;
        }
        .bg-purple {
            background-color: #6f42c1 !important;
        }
        .text-purple {
            color: #6f42c1 !important;
        }
        .alert-purple {
            background-color: rgba(111, 66, 193, 0.1);
            border-color: rgba(111, 66, 193, 0.2);
            color: #6f42c1;
        }
        .alert-purple .fas {
            color: #6f42c1;
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-0">{{ project_name }} System Parameters</h1>
            </div>
            <div>
                                <a href="{{ url_for('maintenance.maintenance_module_page') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Settings
                </a>
            </div>
        </div>

        <!-- General Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-info-circle me-2"></i>General Settings
                </div>
                <form id="generalSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectName" class="form-label">Project Name:</label>
                                <input type="text" class="form-control" id="projectName" value="{{ params.project_name }}" placeholder="Enter project name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectSubtitle" class="form-label">Project Subtitle:</label>
                                <input type="text" class="form-control" id="projectSubtitle" value="{{ params.project_subtitle if params.project_subtitle else 'Management System' }}" placeholder="Enter project subtitle">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="entrySingularLabel" class="form-label">Entry Singular Label:</label>
                                <input type="text" class="form-control" id="entrySingularLabel" value="{{ params.entry_singular_label }}" placeholder="Entry">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="entryPluralLabel" class="form-label">Entry Plural Label:</label>
                                <input type="text" class="form-control" id="entryPluralLabel" value="{{ params.entry_plural_label }}" placeholder="Entries">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-purple">
                        <i class="fas fa-save me-1"></i>Save General Settings
                    </button>
                </form>
                <div id="generalStatusMessage" class="mt-3 d-none"></div>
            </div>
        </div>

        <!-- AI Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-brain me-2"></i>AI Integration Settings
                </div>
                <div class="mb-3">
                    <p class="text-muted">Configure Google Gemini AI for writing assistance with descriptions, notes, and SQL queries.</p>
                </div>
                <form id="aiSettingsForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="geminiApiKey" class="form-label">
                                    <i class="fas fa-key me-1"></i>Google Gemini API Key:
                                </label>
                                <input type="password" class="form-control" id="geminiApiKey" 
                                       value="{{ params.gemini_api_key if params.gemini_api_key else '' }}" 
                                       placeholder="Enter your Google Gemini API key">
                                <small class="text-muted">
                                    Get your API key from 
                                    <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-decoration-none">
                                        Google AI Studio <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">AI Service Status:</label>
                                <div id="aiServiceStatus" class="mt-2">
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Checking...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="geminiModelName" class="form-label">
                                    <i class="fas fa-brain me-1"></i>Gemini Model Name:
                                </label>
                                <input type="text" class="form-control" id="geminiModelName" 
                                       value="{{ params.gemini_model_name if params.gemini_model_name else 'gemini-1.5-flash' }}" 
                                       placeholder="gemini-1.5-flash">
                                <small class="text-muted">
                                    Current models: gemini-1.5-flash (fast), gemini-1.5-pro (advanced)
                                    <br><a href="https://ai.google.dev/gemini-api/docs/models/gemini" target="_blank" class="text-decoration-none">
                                        View available models <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Reserved for future AI settings -->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="geminiBasePrompt" class="form-label">
                                    <i class="fas fa-comment-alt me-1"></i>Base Prompt (Context):
                                </label>
                                <textarea class="form-control" id="geminiBasePrompt" rows="3" 
                                          placeholder="Provide context or instructions that will be included with every AI request">{{ params.gemini_base_prompt if params.gemini_base_prompt else 'You are a helpful assistant for a project management application. Please provide clear, concise, and well-structured responses.' }}</textarea>
                                <small class="text-muted">
                                    This text will be prepended to all AI requests to provide consistent context and instructions.
                                    <br>Example: "You are an expert in [your domain]. Always respond with practical, actionable advice."
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-purple me-2">
                                <i class="fas fa-save me-1"></i>Save AI Settings
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="testAiService()">
                                <i class="fas fa-check-circle me-1"></i>Test Connection
                            </button>
                        </div>
                    </div>
                </form>
                <div id="aiStatusMessage" class="mt-3 d-none"></div>
                
                <!-- AI Features Info -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6><i class="fas fa-magic me-2"></i>Available AI Features:</h6>
                    <ul class="mb-0">
                        <li><strong>Entry Descriptions:</strong> Generate and improve descriptions for entries</li>
                        <li><strong>SQL Assistance:</strong> Generate SQL queries and explanations in the SQL IDE</li>
                        <li><strong>Note Enhancement:</strong> Improve existing notes for clarity and structure</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Label Printing Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-print me-2"></i>Label Printing Settings
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="labelSettingsForm">
                            <div class="mb-3">
                                <label for="labelFontSize" class="form-label">Label Font Size (pt):</label>
                                <input type="number" class="form-control" id="labelFontSize" value="{{ params.label_font_size or '10' }}" min="6" max="20" step="1">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="labelIncludeQr" {{ 'checked' if params.label_include_qr_code == 'true' else '' }}>
                                    <label class="form-check-label" for="labelIncludeQr">
                                        Include QR Code on labels
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="labelQrPrefix" class="form-label">QR Code Prefix (URL/Text):</label>
                                <input type="text" class="form-control" id="labelQrPrefix" value="{{ params.label_qr_code_prefix or 'https://example.com' }}" placeholder="https://example.com">
                                <div class="form-text">This prefix will be combined with "/entry/ID" for QR codes</div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="labelIncludeLogo" {{ 'checked' if params.label_include_logo == 'true' else '' }}>
                                    <label class="form-check-label" for="labelIncludeLogo">
                                        Include project logo on labels
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-save me-1"></i>Save Label Settings
                            </button>
                        </form>
                        <div id="labelStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Label Layout Reference</h5>
                        <div class="mb-3">
                            <strong>8 Labels (2x4):</strong> Standard shipping labels<br>
                            <small class="text-muted">99.1mm x 67.7mm per label</small>
                        </div>
                        <div class="mb-3">
                            <strong>14 Labels (2x7):</strong> Address labels<br>
                            <small class="text-muted">99.1mm x 38.1mm per label</small>
                        </div>
                        <div class="preview-container">
                            <div>
                                <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Label previews will be shown here when generating labels</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduled Jobs Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-clock me-2"></i>Scheduled Jobs Settings
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="overdueSettingsForm">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="overdueCheckEnabled" {{ 'checked' if params.overdue_check_enabled == 'true' else '' }}>
                                    <label class="form-check-label" for="overdueCheckEnabled">
                                        Enable automatic overdue checking
                                    </label>
                                </div>
                                <small class="form-text text-muted">When enabled, the system will automatically check for entries with overdue intended end dates and create notifications.</small>
                            </div>
                            <div class="mb-3">
                                <label for="overdueCheckSchedule" class="form-label">Check Schedule:</label>
                                <select class="form-select" id="overdueCheckSchedule">
                                    <option value="0 9 * * *" {{ 'selected' if params.overdue_check_schedule == '0 9 * * *' else '' }}>Daily at 9:00 AM</option>
                                    <option value="0 8 * * *" {{ 'selected' if params.overdue_check_schedule == '0 8 * * *' else '' }}>Daily at 8:00 AM</option>
                                    <option value="0 10 * * *" {{ 'selected' if params.overdue_check_schedule == '0 10 * * *' else '' }}>Daily at 10:00 AM</option>
                                    <option value="0 0 * * *" {{ 'selected' if params.overdue_check_schedule == '0 0 * * *' else '' }}>Daily at midnight</option>
                                    <option value="0 */6 * * *" {{ 'selected' if params.overdue_check_schedule == '0 */6 * * *' else '' }}>Every 6 hours</option>
                                    <option value="0 */3 * * *" {{ 'selected' if params.overdue_check_schedule == '0 */3 * * *' else '' }}>Every 3 hours</option>
                                    <option value="0 * * * *" {{ 'selected' if params.overdue_check_schedule == '0 * * * *' else '' }}>Every hour</option>
                                    <option value="0 8 * * 1-5" {{ 'selected' if params.overdue_check_schedule == '0 8 * * 1-5' else '' }}>Weekdays at 8:00 AM</option>
                                </select>
                                <small class="form-text text-muted">Choose how often the system should check for overdue entries. The scheduled job will be managed automatically.</small>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary" id="testOverdueCheck">
                                    <i class="fas fa-play me-1"></i>Test Overdue Check Now
                                </button>
                                <small class="form-text text-muted d-block mt-1">Manually trigger an overdue check to test the functionality.</small>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-save me-1"></i>Save Scheduled Job Settings
                            </button>
                        </form>
                        <div id="overdueStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Scheduled Job Status</h5>
                        <div class="mb-3">
                            <div class="alert alert-secondary d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>Checking current status...</strong><br>
                                    <small>Loading job configuration</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Available Jobs:</strong>
                            <ul class="small text-muted mt-2">
                                <li><strong>Overdue Check:</strong> Monitors entries with overdue intended end dates</li>
                                <li><em>More scheduled jobs can be added in the future</em></li>
                            </ul>
                        </div>
                        <div class="preview-container">
                            <div>
                                <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Configure scheduled jobs to run automatically</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Logo Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-image me-2"></i>Project Logo
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="logoUploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="logoFile" class="form-label">Upload Project Logo:</label>
                                <input type="file" class="form-control" id="logoFile" accept="image/*">
                                <small class="form-text text-muted">Supported formats: PNG, JPG, JPEG, GIF. Recommended size: 150x150px or smaller.</small>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-upload me-1"></i>Upload Logo
                            </button>
                            {% if params.project_logo_path %}
                            <button type="button" class="btn btn-outline-danger ms-2" id="removeLogo">
                                <i class="fas fa-trash me-1"></i>Remove Logo
                            </button>
                            {% endif %}
                        </form>
                        <div id="logoStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Current Logo</h5>
                        <div class="preview-container" id="logoPreviewContainer">
                            {% if params.project_logo_path %}
                                <img src="{{ params.project_logo_path }}" alt="Project Logo" class="logo-preview">
                            {% else %}
                                <div>
                                    <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No logo uploaded</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // General Settings Form
        document.getElementById('generalSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                project_name: document.getElementById('projectName').value,
                project_subtitle: document.getElementById('projectSubtitle').value,
                entry_singular_label: document.getElementById('entrySingularLabel').value,
                entry_plural_label: document.getElementById('entryPluralLabel').value
            };
            
            try {
                displayStatus('generalStatusMessage', 'Saving settings...', 'alert-info');
                
                const response = await fetch('/api/system_params', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save settings');
                
                displayStatus('generalStatusMessage', 'Settings saved successfully!', 'alert-success');
                
                // Update page title and header
                document.title = `${formData.project_name} - Settings`;
                const headerElement = document.querySelector('h1');
                if (headerElement) {
                    headerElement.textContent = `${formData.project_name} System Parameters`;
                }
                
            } catch (error) {
                displayStatus('generalStatusMessage', 'Failed to save settings: ' + error.message, 'alert-danger');
            }
        });

        // Label Settings Form
        document.getElementById('labelSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                label_font_size: document.getElementById('labelFontSize').value,
                label_include_qr_code: document.getElementById('labelIncludeQr').checked ? 'true' : 'false',
                label_qr_code_prefix: document.getElementById('labelQrPrefix').value,
                label_include_logo: document.getElementById('labelIncludeLogo').checked ? 'true' : 'false'
            };
            
            try {
                displayStatus('labelStatusMessage', 'Saving label settings...', 'alert-info');
                
                const response = await fetch('/api/system_params', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save label settings');
                
                displayStatus('labelStatusMessage', 'Label settings saved successfully!', 'alert-success');
                
            } catch (error) {
                displayStatus('labelStatusMessage', 'Failed to save label settings: ' + error.message, 'alert-danger');
            }
        });

        // AI Settings Form
        document.getElementById('aiSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                gemini_api_key: document.getElementById('geminiApiKey').value,
                gemini_model_name: document.getElementById('geminiModelName').value,
                gemini_base_prompt: document.getElementById('geminiBasePrompt').value
            };
            
            try {
                displayStatus('aiStatusMessage', 'Saving AI settings...', 'alert-info');
                
                const response = await fetch('/api/system_params', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save AI settings');
                
                displayStatus('aiStatusMessage', 'AI settings saved successfully!', 'alert-success');
                
                // Update AI service status after saving
                checkAiServiceStatus();
                
            } catch (error) {
                displayStatus('aiStatusMessage', 'Failed to save AI settings: ' + error.message, 'alert-danger');
            }
        });

        // Logo Upload Form
        document.getElementById('logoUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('logoFile');
            if (!fileInput.files[0]) {
                displayStatus('logoStatusMessage', 'Please select a logo file', 'alert-warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('logo', fileInput.files[0]);
            
            try {
                displayStatus('logoStatusMessage', 'Uploading logo...', 'alert-info');
                
                const response = await fetch('/api/upload_logo', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Failed to upload logo');
                
                const result = await response.json();
                displayStatus('logoStatusMessage', 'Logo uploaded successfully!', 'alert-success');
                
                // Update logo preview
                document.getElementById('logoPreviewContainer').innerHTML = 
                    `<img src="${result.logo_path}" alt="Project Logo" class="logo-preview">`;
                
                // Add remove button if it doesn't exist
                if (!document.getElementById('removeLogo')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-outline-danger ms-2';
                    removeBtn.id = 'removeLogo';
                    removeBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Remove Logo';
                    removeBtn.addEventListener('click', removeLogo);
                    
                    const submitButton = document.querySelector('#logoUploadForm button[type="submit"]');
                    if (submitButton && submitButton.parentNode) {
                        submitButton.parentNode.appendChild(removeBtn);
                    } else {
                        console.error('Could not find logo upload form submit button');
                    }
                }
                
                // Clear file input
                fileInput.value = '';
                
            } catch (error) {
                displayStatus('logoStatusMessage', 'Failed to upload logo: ' + error.message, 'alert-danger');
            }
        });

        // Remove Logo Function
        function removeLogo() {
            if (!confirm('Are you sure you want to remove the current logo?')) return;
            
            fetch('/api/system_params', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_logo_path: '' })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to remove logo');
                
                document.getElementById('logoPreviewContainer').innerHTML = 
                    `<div><i class="fas fa-image fa-3x text-muted mb-3"></i><p class="text-muted">No logo uploaded</p></div>`;
                
                const removeBtn = document.getElementById('removeLogo');
                if (removeBtn) removeBtn.remove();
                
                displayStatus('logoStatusMessage', 'Logo removed successfully!', 'alert-success');
            })
            .catch(error => {
                displayStatus('logoStatusMessage', 'Failed to remove logo: ' + error.message, 'alert-danger');
            });
        }

        // Attach remove logo event if button exists
        const removeLogoBtn = document.getElementById('removeLogo');
        if (removeLogoBtn) {
            removeLogoBtn.addEventListener('click', removeLogo);
        }

        // Overdue Settings Form
        document.getElementById('overdueSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const enabled = document.getElementById('overdueCheckEnabled').checked;
            const schedule = document.getElementById('overdueCheckSchedule').value;
            
            const formData = {
                overdue_check_enabled: enabled ? 'true' : 'false',
                overdue_check_schedule: schedule
            };
            
            try {
                displayStatus('overdueStatusMessage', 'Saving scheduled job settings...', 'alert-info');
                
                // Save settings to database
                const settingsResponse = await fetch('/api/system_params', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!settingsResponse.ok) throw new Error('Failed to save settings');
                
                // Automatically manage cron job
                const cronResponse = await fetch('/api/cron/overdue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: enabled,
                        schedule: schedule
                    })
                });
                
                const cronResult = await cronResponse.json();
                
                if (!cronResponse.ok) {
                    throw new Error('Settings saved but failed to manage scheduled job: ' + (cronResult.error || 'Unknown error'));
                }
                
                const status = enabled ? 'enabled and scheduled' : 'disabled';
                displayStatus('overdueStatusMessage', 
                    `Settings saved successfully! Overdue check job ${status} automatically.`, 
                    'alert-success');
                
                // Update the status display
                updateJobStatus(enabled, schedule, cronResult);
                
            } catch (error) {
                displayStatus('overdueStatusMessage', 'Error: ' + error.message, 'alert-danger');
            }
        });

        // Update job status display
        function updateJobStatus(enabled, schedule, cronResult = null) {
            // Find the specific overdue notification status container
            const overdueSection = document.querySelector('#overdueSettingsForm').closest('.section-card');
            const statusContainer = overdueSection.querySelector('.col-md-6:nth-child(2)');
            
            if (enabled) {
                // Show active job status
                statusContainer.innerHTML = `
                    <h5>Scheduled Job Status</h5>
                    <div class="mb-3">
                        <div class="alert alert-purple d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            <div>
                                <strong>Overdue Check: Active</strong><br>
                                <small>Schedule: ${schedule} (${getScheduleDescription(schedule)})</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>What happens automatically:</strong>
                        <ul class="small text-muted mt-2">
                            <li>System checks for entries with overdue intended end dates</li>
                            <li>High-priority notifications are created for overdue items</li>
                            <li>Only applies to entry types with "Show End Date fields" enabled</li>
                            <li>Duplicate notifications are prevented automatically</li>
                        </ul>
                    </div>
                    <div class="preview-container">
                        <div>
                            <i class="fas fa-cogs fa-3x text-purple mb-3"></i>
                            <p class="text-muted">Scheduled job is running automatically</p>
                        </div>
                    </div>
                `;
            } else {
                // Show inactive job status
                statusContainer.innerHTML = `
                    <h5>Scheduled Job Status</h5>
                    <div class="mb-3">
                        <div class="alert alert-secondary d-flex align-items-center">
                            <i class="fas fa-pause-circle me-2"></i>
                            <div>
                                <strong>Overdue Check: Inactive</strong><br>
                                <small>Enable above to start automatic checking</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>When enabled, the system will:</strong>
                        <ul class="small text-muted mt-2">
                            <li>Check for entries with overdue intended end dates</li>
                            <li>Create high-priority notifications for overdue items</li>
                            <li>Run according to your selected schedule</li>
                            <li>Apply only to entry types with end date fields enabled</li>
                        </ul>
                    </div>
                    <div class="preview-container">
                        <div>
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No scheduled jobs are currently active</p>
                        </div>
                    </div>
                `;
            }
        }

        // Get human-readable description of cron schedule
        function getScheduleDescription(schedule) {
            const scheduleMap = {
                '0 9 * * *': 'Daily at 9:00 AM',
                '0 8 * * *': 'Daily at 8:00 AM',
                '0 10 * * *': 'Daily at 10:00 AM',
                '0 0 * * *': 'Daily at midnight',
                '0 */6 * * *': 'Every 6 hours',
                '0 */3 * * *': 'Every 3 hours',
                '0 * * * *': 'Every hour',
                '0 8 * * 1-5': 'Weekdays at 8:00 AM'
            };
            return scheduleMap[schedule] || 'Custom schedule';
        }

        // Update display when schedule changes
        document.getElementById('overdueCheckSchedule').addEventListener('change', function() {
            const enabled = document.getElementById('overdueCheckEnabled').checked;
            updateJobStatus(enabled, this.value);
        });

        // Update display when enabled/disabled
        document.getElementById('overdueCheckEnabled').addEventListener('change', function() {
            const schedule = document.getElementById('overdueCheckSchedule').value;
            updateJobStatus(this.checked, schedule);
        });

        // Initialize page display
        document.addEventListener('DOMContentLoaded', function() {
            const enabled = document.getElementById('overdueCheckEnabled').checked;
            const schedule = document.getElementById('overdueCheckSchedule').value;
            updateJobStatus(enabled, schedule);
            
            // Load current cron status
            loadCurrentJobStatus();
        });

        // Load current job status from server
        async function loadCurrentJobStatus() {
            try {
                const response = await fetch('/api/cron/overdue/status');
                if (response.ok) {
                    const status = await response.json();
                    const enabled = document.getElementById('overdueCheckEnabled').checked;
                    const schedule = document.getElementById('overdueCheckSchedule').value;
                    
                    // Show warning if settings don't match actual cron job
                    if (enabled !== status.enabled) {
                        displayStatus('overdueStatusMessage', 
                            `Warning: Settings (${enabled ? 'enabled' : 'disabled'}) don't match actual job status (${status.enabled ? 'enabled' : 'disabled'}). Save settings to synchronize.`, 
                            'alert-warning');
                    }
                }
            } catch (error) {
                console.log('Could not load job status:', error.message);
            }
        }

        // Test Overdue Check Button
        document.getElementById('testOverdueCheck').addEventListener('click', async () => {
            try {
                displayStatus('overdueStatusMessage', 'Running overdue check...', 'alert-info');
                
                const response = await fetch('/api/check_overdue_end_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Failed to run overdue check');
                
                const result = await response.json();
                const message = result.notifications_created > 0 
                    ? `Overdue check completed! Created ${result.notifications_created} notification(s).`
                    : 'Overdue check completed. No overdue entries found.';
                
                displayStatus('overdueStatusMessage', message, 'alert-success');
                
            } catch (error) {
                displayStatus('overdueStatusMessage', 'Failed to run overdue check: ' + error.message, 'alert-danger');
            }
        });

        // Status message helper
        function displayStatus(elementId, message, alertClass) {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) {
                console.error(`Status element with ID '${elementId}' not found`);
                return;
            }
            statusElement.className = `alert ${alertClass}`;
            statusElement.textContent = message;
            statusElement.classList.remove('d-none');
            
            if (alertClass === 'alert-success') {
                setTimeout(() => {
                    statusElement.classList.add('d-none');
                }, 3000);
            }
        }

        // AI Service functions
        async function checkAiServiceStatus() {
            try {
                const response = await fetch('/api/ai/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('aiServiceStatus');
                if (data.available) {
                    statusElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Available</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle me-1"></i>Not Configured</span>';
                }
            } catch (error) {
                const statusElement = document.getElementById('aiServiceStatus');
                statusElement.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Error</span>';
                console.error('Error checking AI service status:', error);
            }
        }

        async function testAiService() {
            try {
                displayStatus('aiStatusMessage', 'Testing AI connection...', 'alert-info');
                
                const response = await fetch('/api/ai/generate_description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: 'Test Entry',
                        entry_type: 'test',
                        context: 'This is a test to verify AI connectivity'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayStatus('aiStatusMessage', '✅ AI service is working correctly! Generated test description successfully.', 'alert-success');
                } else {
                    displayStatus('aiStatusMessage', '❌ AI service test failed: ' + (data.error || 'Unknown error'), 'alert-danger');
                }
                
                // Update status badge
                checkAiServiceStatus();
                
            } catch (error) {
                displayStatus('aiStatusMessage', '❌ Failed to test AI service: ' + error.message, 'alert-danger');
                console.error('Error testing AI service:', error);
            }
        }

        // Check AI service status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAiServiceStatus();
        });
    </script>
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>
</body>
</html>
