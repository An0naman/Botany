<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - System Parameters</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications_modern.css') }}">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 30px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .settings-section {
            margin-bottom: 2rem;
        }
        .section-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #6f42c1, #d63384);
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #6f42c1;
        }
        .form-control, .form-select {
            margin-bottom: 15px;
        }
        .preview-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }
        .logo-preview {
            max-width: 150px;
            max-height: 150px;
        }
        .btn-purple {
            background: linear-gradient(135deg, #6f42c1, #d63384);
            border: none;
            color: white;
        }
        .btn-purple:hover {
            background: linear-gradient(135deg, #5a359a, #b02a5b);
            color: white;
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-0">{{ project_name }} System Parameters</h1>
            </div>
            <div>
                <a href="{{ url_for('maintenance.maintenance_module_page') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>
        </div>

        <!-- General Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-info-circle me-2"></i>General Settings
                </div>
                <form id="generalSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectName" class="form-label">Project Name:</label>
                                <input type="text" class="form-control" id="projectName" value="{{ params.project_name }}" placeholder="Enter project name">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="entrySingularLabel" class="form-label">Entry Singular Label:</label>
                                <input type="text" class="form-control" id="entrySingularLabel" value="{{ params.entry_singular_label }}" placeholder="Entry">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="entryPluralLabel" class="form-label">Entry Plural Label:</label>
                                <input type="text" class="form-control" id="entryPluralLabel" value="{{ params.entry_plural_label }}" placeholder="Entries">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-purple">
                        <i class="fas fa-save me-1"></i>Save General Settings
                    </button>
                </form>
                <div id="generalStatusMessage" class="mt-3 d-none"></div>
            </div>
        </div>

        <!-- Label Printing Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-print me-2"></i>Label Printing Settings
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="labelSettingsForm">
                            <div class="mb-3">
                                <label for="labelFontSize" class="form-label">Label Font Size (pt):</label>
                                <input type="number" class="form-control" id="labelFontSize" value="{{ params.label_font_size or '10' }}" min="6" max="20" step="1">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="labelIncludeQr" {{ 'checked' if params.label_include_qr_code == 'true' else '' }}>
                                    <label class="form-check-label" for="labelIncludeQr">
                                        Include QR Code on labels
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="labelIncludeLogo" {{ 'checked' if params.label_include_logo == 'true' else '' }}>
                                    <label class="form-check-label" for="labelIncludeLogo">
                                        Include project logo on labels
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-save me-1"></i>Save Label Settings
                            </button>
                        </form>
                        <div id="labelStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Label Layout Reference</h5>
                        <div class="mb-3">
                            <strong>8 Labels (2x4):</strong> Standard shipping labels<br>
                            <small class="text-muted">99.1mm x 67.7mm per label</small>
                        </div>
                        <div class="mb-3">
                            <strong>14 Labels (2x7):</strong> Address labels<br>
                            <small class="text-muted">99.1mm x 38.1mm per label</small>
                        </div>
                        <div class="preview-container">
                            <div>
                                <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Label previews will be shown here when generating labels</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overdue Notification Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-clock me-2"></i>Overdue Notification Settings
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="overdueSettingsForm">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="overdueCheckEnabled" {{ 'checked' if params.overdue_check_enabled == 'true' else '' }}>
                                    <label class="form-check-label" for="overdueCheckEnabled">
                                        Enable automatic overdue notifications
                                    </label>
                                </div>
                                <small class="form-text text-muted">When enabled, the system will check for entries with overdue intended end dates and create notifications.</small>
                            </div>
                            <div class="mb-3">
                                <label for="overdueCheckSchedule" class="form-label">Check Schedule (Cron Format):</label>
                                <select class="form-select" id="overdueCheckSchedule">
                                    <option value="0 9 * * *" {{ 'selected' if params.overdue_check_schedule == '0 9 * * *' else '' }}>Daily at 9:00 AM</option>
                                    <option value="0 8 * * *" {{ 'selected' if params.overdue_check_schedule == '0 8 * * *' else '' }}>Daily at 8:00 AM</option>
                                    <option value="0 10 * * *" {{ 'selected' if params.overdue_check_schedule == '0 10 * * *' else '' }}>Daily at 10:00 AM</option>
                                    <option value="0 0 * * *" {{ 'selected' if params.overdue_check_schedule == '0 0 * * *' else '' }}>Daily at midnight</option>
                                    <option value="0 */6 * * *" {{ 'selected' if params.overdue_check_schedule == '0 */6 * * *' else '' }}>Every 6 hours</option>
                                    <option value="0 */3 * * *" {{ 'selected' if params.overdue_check_schedule == '0 */3 * * *' else '' }}>Every 3 hours</option>
                                    <option value="0 * * * *" {{ 'selected' if params.overdue_check_schedule == '0 * * * *' else '' }}>Every hour</option>
                                    <option value="0 8 * * 1-5" {{ 'selected' if params.overdue_check_schedule == '0 8 * * 1-5' else '' }}>Weekdays at 8:00 AM</option>
                                </select>
                                <small class="form-text text-muted">Choose how often the system should check for overdue entries. You'll need to set up the cron job using this schedule.</small>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary" id="testOverdueCheck">
                                    <i class="fas fa-play me-1"></i>Test Overdue Check Now
                                </button>
                                <small class="form-text text-muted d-block mt-1">Manually trigger an overdue check to test the functionality.</small>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-save me-1"></i>Save Overdue Settings
                            </button>
                        </form>
                        <div id="overdueStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Setup Instructions</h5>
                        <div class="mb-3">
                            <strong>Step 1:</strong> Configure settings here<br>
                            <small class="text-muted">Enable notifications and set your preferred schedule</small>
                        </div>
                        <div class="mb-3">
                            <strong>Step 2:</strong> Set up cron job<br>
                            <small class="text-muted">Add the schedule to your system's crontab:</small><br>
                            <code id="cronCommand" class="small">{{ params.overdue_check_schedule or '0 9 * * *' }} /path/to/project/cron_check_overdue.sh</code>
                        </div>
                        <div class="mb-3">
                            <strong>Step 3:</strong> Configure entry types<br>
                            <small class="text-muted">Enable "Show End Date fields" for entry types that should be monitored</small>
                        </div>
                        <div class="preview-container">
                            <div>
                                <i class="fas fa-bell fa-3x text-muted mb-3"></i>
                                <p class="text-muted">High-priority notifications will be created when intended end dates pass</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Logo Settings -->
        <div class="settings-section">
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-image me-2"></i>Project Logo
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form id="logoUploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="logoFile" class="form-label">Upload Project Logo:</label>
                                <input type="file" class="form-control" id="logoFile" accept="image/*">
                                <small class="form-text text-muted">Supported formats: PNG, JPG, JPEG, GIF. Recommended size: 150x150px or smaller.</small>
                            </div>
                            <button type="submit" class="btn btn-purple">
                                <i class="fas fa-upload me-1"></i>Upload Logo
                            </button>
                            {% if params.project_logo_path %}
                            <button type="button" class="btn btn-outline-danger ms-2" id="removeLogo">
                                <i class="fas fa-trash me-1"></i>Remove Logo
                            </button>
                            {% endif %}
                        </form>
                        <div id="logoStatusMessage" class="mt-3 d-none"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Current Logo</h5>
                        <div class="preview-container" id="logoPreviewContainer">
                            {% if params.project_logo_path %}
                                <img src="{{ params.project_logo_path }}" alt="Project Logo" class="logo-preview">
                            {% else %}
                                <div>
                                    <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No logo uploaded</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // General Settings Form
        document.getElementById('generalSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                project_name: document.getElementById('projectName').value,
                entry_singular_label: document.getElementById('entrySingularLabel').value,
                entry_plural_label: document.getElementById('entryPluralLabel').value
            };
            
            try {
                displayStatus('generalStatusMessage', 'Saving settings...', 'alert-info');
                
                const response = await fetch('/api/system_parameters', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save settings');
                
                displayStatus('generalStatusMessage', 'Settings saved successfully!', 'alert-success');
                
                // Update page title and navbar
                document.title = `${formData.project_name} - Settings`;
                document.querySelector('.navbar-brand').innerHTML = `<i class="fas fa-home me-2"></i>${formData.project_name}`;
                
            } catch (error) {
                displayStatus('generalStatusMessage', 'Failed to save settings: ' + error.message, 'alert-danger');
            }
        });

        // Label Settings Form
        document.getElementById('labelSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                label_font_size: document.getElementById('labelFontSize').value,
                label_include_qr_code: document.getElementById('labelIncludeQr').checked ? 'true' : 'false',
                label_include_logo: document.getElementById('labelIncludeLogo').checked ? 'true' : 'false'
            };
            
            try {
                displayStatus('labelStatusMessage', 'Saving label settings...', 'alert-info');
                
                const response = await fetch('/api/system_parameters', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save label settings');
                
                displayStatus('labelStatusMessage', 'Label settings saved successfully!', 'alert-success');
                
            } catch (error) {
                displayStatus('labelStatusMessage', 'Failed to save label settings: ' + error.message, 'alert-danger');
            }
        });

        // Logo Upload Form
        document.getElementById('logoUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('logoFile');
            if (!fileInput.files[0]) {
                displayStatus('logoStatusMessage', 'Please select a logo file', 'alert-warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('logo', fileInput.files[0]);
            
            try {
                displayStatus('logoStatusMessage', 'Uploading logo...', 'alert-info');
                
                const response = await fetch('/api/upload_logo', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Failed to upload logo');
                
                const result = await response.json();
                displayStatus('logoStatusMessage', 'Logo uploaded successfully!', 'alert-success');
                
                // Update logo preview
                document.getElementById('logoPreviewContainer').innerHTML = 
                    `<img src="${result.logo_path}" alt="Project Logo" class="logo-preview">`;
                
                // Add remove button if it doesn't exist
                if (!document.getElementById('removeLogo')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-outline-danger ms-2';
                    removeBtn.id = 'removeLogo';
                    removeBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Remove Logo';
                    removeBtn.addEventListener('click', removeLogo);
                    document.querySelector('#logoUploadForm button[type="submit"]').parentNode.appendChild(removeBtn);
                }
                
                // Clear file input
                fileInput.value = '';
                
            } catch (error) {
                displayStatus('logoStatusMessage', 'Failed to upload logo: ' + error.message, 'alert-danger');
            }
        });

        // Remove Logo Function
        function removeLogo() {
            if (!confirm('Are you sure you want to remove the current logo?')) return;
            
            fetch('/api/system_parameters', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_logo_path: '' })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to remove logo');
                
                document.getElementById('logoPreviewContainer').innerHTML = 
                    `<div><i class="fas fa-image fa-3x text-muted mb-3"></i><p class="text-muted">No logo uploaded</p></div>`;
                
                const removeBtn = document.getElementById('removeLogo');
                if (removeBtn) removeBtn.remove();
                
                displayStatus('logoStatusMessage', 'Logo removed successfully!', 'alert-success');
            })
            .catch(error => {
                displayStatus('logoStatusMessage', 'Failed to remove logo: ' + error.message, 'alert-danger');
            });
        }

        // Attach remove logo event if button exists
        const removeLogoBtn = document.getElementById('removeLogo');
        if (removeLogoBtn) {
            removeLogoBtn.addEventListener('click', removeLogo);
        }

        // Overdue Settings Form
        document.getElementById('overdueSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                overdue_check_enabled: document.getElementById('overdueCheckEnabled').checked ? 'true' : 'false',
                overdue_check_schedule: document.getElementById('overdueCheckSchedule').value
            };
            
            try {
                displayStatus('overdueStatusMessage', 'Saving overdue settings...', 'alert-info');
                
                const response = await fetch('/api/system_parameters', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Failed to save overdue settings');
                
                displayStatus('overdueStatusMessage', 'Overdue settings saved successfully!', 'alert-success');
                
                // Update the cron command display
                document.getElementById('cronCommand').textContent = 
                    `${formData.overdue_check_schedule} /path/to/project/cron_check_overdue.sh`;
                
            } catch (error) {
                displayStatus('overdueStatusMessage', 'Failed to save overdue settings: ' + error.message, 'alert-danger');
            }
        });

        // Update cron command display when schedule changes
        document.getElementById('overdueCheckSchedule').addEventListener('change', function() {
            document.getElementById('cronCommand').textContent = 
                `${this.value} /path/to/project/cron_check_overdue.sh`;
        });

        // Test Overdue Check Button
        document.getElementById('testOverdueCheck').addEventListener('click', async () => {
            try {
                displayStatus('overdueStatusMessage', 'Running overdue check...', 'alert-info');
                
                const response = await fetch('/api/check_overdue_end_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Failed to run overdue check');
                
                const result = await response.json();
                const message = result.notifications_created > 0 
                    ? `Overdue check completed! Created ${result.notifications_created} notification(s).`
                    : 'Overdue check completed. No overdue entries found.';
                
                displayStatus('overdueStatusMessage', message, 'alert-success');
                
            } catch (error) {
                displayStatus('overdueStatusMessage', 'Failed to run overdue check: ' + error.message, 'alert-danger');
            }
        });

        // Status message helper
        function displayStatus(elementId, message, alertClass) {
            const statusElement = document.getElementById(elementId);
            statusElement.className = `alert ${alertClass}`;
            statusElement.textContent = message;
            statusElement.classList.remove('d-none');
            
            if (alertClass === 'alert-success') {
                setTimeout(() => {
                    statusElement.classList.add('d-none');
                }, 3000);
            }
        }
    </script>
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>
</body>
</html>
