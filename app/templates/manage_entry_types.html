<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - Manage Entry Types</title>                                <td colspan="7" class="text-center text-muted py-4">    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 30px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .content-section {
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
        }
        .content-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
        }
        .form-control, .form-select {
            margin-bottom: 15px;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .action-buttons button {
            margin-right: 5px;
        }
        .btn-blue {
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
            border: none;
            color: white;
        }
        .btn-blue:hover {
            background: linear-gradient(135deg, #0a58ca, #5a359a);
            color: white;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }
        .table thead th {
            background: #f8f9fa;
            border-bottom: 2px solid #0d6efd;
            color: #495057;
            font-weight: 600;
            letter-spacing: 0.3px;
            font-size: 0.9rem;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .status-icon {
            font-size: 1.1em;
        }
        .btn-spacing {
            margin-left: 1rem;
        }
        @media (max-width: 768px) {
            .container {
                margin-top: 15px;
                padding: 20px;
            }
            .modal-dialog {
                margin: 0.5rem;
            }
            .header-actions {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .btn-spacing {
                margin-left: 0;
                margin-top: 0.5rem;
            }
            .table-container {
                font-size: 0.875rem;
            }
            .table th, .table td {
                padding: 0.5rem 0.25rem;
            }
            .action-buttons .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1 class="mb-0">{{ project_name }} {{ entry_plural_label }} Types</h1>
            </div>
            <div class="header-actions d-flex align-items-center">
                <a href="{{ url_for('maintenance.maintenance_module_page') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
                <button id="showAddEntryTypeModalBtn" class="btn btn-blue btn-spacing">
                    <i class="fas fa-plus me-1"></i>Add Type
                </button>
            </div>
        </div>

        <div class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-primary">
                    <i class="fas fa-tags me-2"></i>Entry Types
                </h5>
            </div>

            <div class="table-container">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Singular Label</th>
                            <th>Plural Label</th>
                            <th>Description</th>
                            <th>Note Types</th>
                            <th class="text-center">Primary</th>
                            <th class="text-center">Labels</th>
                            <th class="text-center">End Dates</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="entryTypesTableBody">
                        {% if entry_types %}
                            {% for type in entry_types %}
                                <tr data-id="{{ type.id }}">
                                    <td><strong>{{ type.name }}</strong></td>
                                    <td>{{ type.singular_label }}</td>
                                    <td>{{ type.plural_label }}</td>
                                    <td>{{ type.description | truncate(50) }}</td>
                                    <td><span class="badge bg-light text-dark">{{ type.note_types | truncate(30) }}</span></td>
                                    <td class="text-center">
                                        {% if type.is_primary %}
                                            <i class="fas fa-star status-icon text-warning" title="Primary Type"></i>
                                        {% else %}
                                            <i class="far fa-star status-icon text-muted" title="Not Primary"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if type.show_labels_section %}
                                            <i class="fas fa-check-circle status-icon text-success" title="Shows Labels Section"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle status-icon text-muted" title="No Labels Section"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if type.show_end_dates %}
                                            <i class="fas fa-check-circle status-icon text-success" title="Shows End Date Fields"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle status-icon text-muted" title="No End Date Fields"></i>
                                        {% endif %}
                                    </td>
                                    <td class="action-buttons text-center">
                                        <button class="btn btn-sm btn-outline-primary edit-entry-type-btn"
                                                data-id="{{ type.id }}"
                                                data-name="{{ type.name }}"
                                                data-singular="{{ type.singular_label }}"
                                                data-plural="{{ type.plural_label }}"
                                                data-description="{{ type.description }}"
                                                data-note-types="{{ type.note_types }}"
                                                data-is-primary="{{ type.is_primary }}"
                                                data-show-labels-section="{{ type.show_labels_section | default(1, true) }}"
                                                data-show-end-dates="{{ type.show_end_dates | default(0, true) }}"
                                                title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-entry-type-btn ms-1" 
                                                data-id="{{ type.id }}"
                                                title="Delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block text-muted opacity-50"></i>
                                    No entry types defined yet.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Entry Type Modal -->
    <div class="modal fade" id="entryTypeModal" tabindex="-1" aria-labelledby="entryTypeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryTypeModalLabel">Add/Edit Entry Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="entryTypeForm">
                        <input type="hidden" id="entryTypeId">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name (Internal Identifier):</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="singularLabel" class="form-label">Singular Label (e.g., "Book"):</label>
                            <input type="text" class="form-control" id="singularLabel" required>
                        </div>
                        <div class="mb-3">
                            <label for="pluralLabel" class="form-label">Plural Label (e.g., "Books"):</label>
                            <input type="text" class="form-control" id="pluralLabel" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description:</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="noteTypes" class="form-label">Default Note Types:</label>
                            <div id="noteTypesContainer">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Select from available note types</small>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="refreshNoteTypesBtn">
                                        <i class="fas fa-sync-alt"></i> Refresh Types
                                    </button>
                                </div>
                                <div id="noteTypesCheckboxes" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-spinner fa-spin"></i> Loading note types...
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="noteTypes" value="General">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isPrimary">
                            <label class="form-check-label" for="isPrimary">
                                Mark as Primary Entry Type (Only one can be primary)
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="showLabelsSection" checked>
                            <label class="form-check-label" for="showLabelsSection">
                                Show Labels Section for entries of this type
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="showEndDates">
                            <label class="form-check-label" for="showEndDates">
                                Show End Date fields (Intended & Actual) for entries of this type
                            </label>
                        </div>
                        <button type="submit" class="btn btn-blue w-100">Save Entry Type</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const entryTypeModal = new bootstrap.Modal(document.getElementById('entryTypeModal'));
            const entryTypeForm = document.getElementById('entryTypeForm');
            const entryTypeIdInput = document.getElementById('entryTypeId');
            const nameInput = document.getElementById('name');
            const singularLabelInput = document.getElementById('singularLabel');
            const pluralLabelInput = document.getElementById('pluralLabel');
            const descriptionInput = document.getElementById('description');
            const noteTypesInput = document.getElementById('noteTypes');
            const noteTypesCheckboxes = document.getElementById('noteTypesCheckboxes');
            const refreshNoteTypesBtn = document.getElementById('refreshNoteTypesBtn');
            const isPrimaryInput = document.getElementById('isPrimary');
            const showLabelsSectionInput = document.getElementById('showLabelsSection');
            const showEndDatesInput = document.getElementById('showEndDates');

            let availableNoteTypes = [];

            // Load available note types from system parameters
            async function loadNoteTypes() {
                try {
                    noteTypesCheckboxes.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading note types...</div>';
                    
                    const response = await fetch('/api/system_params');
                    const params = await response.json();
                    
                    // Default note types
                    const defaultTypes = ['General', 'Info', 'Important', 'Critical', 'Warning', 'Caution', 'Success', 'Completed'];
                    
                    // Custom note types from system parameters
                    let customTypes = [];
                    if (params.custom_note_types) {
                        const customTypesData = JSON.parse(params.custom_note_types);
                        customTypes = customTypesData.map(type => type.name);
                    }
                    
                    // Combine and deduplicate
                    availableNoteTypes = [...new Set([...defaultTypes, ...customTypes])];
                    
                    renderNoteTypesCheckboxes();
                } catch (error) {
                    console.error('Error loading note types:', error);
                    noteTypesCheckboxes.innerHTML = '<div class="text-danger text-center py-3"><i class="fas fa-exclamation-triangle"></i> Error loading note types</div>';
                }
            }

            // Render note types as checkboxes
            function renderNoteTypesCheckboxes() {
                if (availableNoteTypes.length === 0) {
                    noteTypesCheckboxes.innerHTML = '<div class="text-muted text-center py-3">No note types available. Create some in Notes Configuration.</div>';
                    return;
                }

                let checkboxesHtml = '';
                availableNoteTypes.forEach((noteType, index) => {
                    checkboxesHtml += `
                        <div class="form-check mb-2">
                            <input class="form-check-input note-type-checkbox" type="checkbox" 
                                   value="${noteType}" id="noteType_${index}">
                            <label class="form-check-label" for="noteType_${index}">
                                ${noteType}
                            </label>
                        </div>
                    `;
                });

                noteTypesCheckboxes.innerHTML = checkboxesHtml;
                
                // Add event listeners to update hidden input
                document.querySelectorAll('.note-type-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateNoteTypesHiddenInput);
                });
            }

            // Update the hidden input with selected note types
            function updateNoteTypesHiddenInput() {
                const selectedTypes = [];
                document.querySelectorAll('.note-type-checkbox:checked').forEach(checkbox => {
                    selectedTypes.push(checkbox.value);
                });
                noteTypesInput.value = selectedTypes.join(', ');
            }

            // Set selected note types from comma-separated string
            function setSelectedNoteTypes(noteTypesString) {
                const selectedTypes = noteTypesString ? noteTypesString.split(',').map(type => type.trim()) : [];
                
                document.querySelectorAll('.note-type-checkbox').forEach(checkbox => {
                    checkbox.checked = selectedTypes.includes(checkbox.value);
                });
                
                updateNoteTypesHiddenInput();
            }

            // Refresh note types button
            refreshNoteTypesBtn.addEventListener('click', loadNoteTypes);

            // Load note types on page load
            loadNoteTypes();

            // Show Add Modal
            document.getElementById('showAddEntryTypeModalBtn').addEventListener('click', function() {
                // Reset form for adding new
                entryTypeIdInput.value = '';
                entryTypeForm.reset();
                nameInput.readOnly = false; // Name is editable for new entries
                document.getElementById('entryTypeModalLabel').textContent = 'Add New Entry Type';
                
                // Set default note type selection (General)
                setTimeout(() => {
                    setSelectedNoteTypes('General');
                }, 100);
                
                entryTypeModal.show();
            });

            // Handle Edit Buttons
            document.querySelectorAll('.edit-entry-type-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.getElementById('entryTypeModalLabel').textContent = 'Edit Entry Type';
                    entryTypeIdInput.value = this.dataset.id;
                    nameInput.value = this.dataset.name;
                    singularLabelInput.value = this.dataset.singular;
                    pluralLabelInput.value = this.dataset.plural;
                    descriptionInput.value = this.dataset.description;
                    isPrimaryInput.checked = (this.dataset.isPrimary === '1');
                    showLabelsSectionInput.checked = (this.dataset.showLabelsSection === '1');
                    showEndDatesInput.checked = (this.dataset.showEndDates === '1');
                    nameInput.readOnly = true; // Name is not editable for existing entries
                    
                    // Set note types selection
                    setTimeout(() => {
                        setSelectedNoteTypes(this.dataset.noteTypes);
                    }, 100);
                    
                    entryTypeModal.show();
                });
            });

            // Handle Form Submission (Add/Edit)
            entryTypeForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const id = entryTypeIdInput.value;
                const method = id ? 'PATCH' : 'POST';
                const url = id ? `/api/entry_types/${id}` : '/api/entry_types';

                const data = {
                    name: nameInput.value,
                    singular_label: singularLabelInput.value,
                    plural_label: pluralLabelInput.value,
                    description: descriptionInput.value,
                    note_types: noteTypesInput.value,
                    is_primary: isPrimaryInput.checked ? 1 : 0,
                    show_labels_section: showLabelsSectionInput.checked ? 1 : 0,
                    show_end_dates: showEndDatesInput.checked ? 1 : 0
                };

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        entryTypeModal.hide();
                        window.location.reload(); // Reload page to show updated list
                    } else if (data.error) {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                });
            });

            // Handle Delete Buttons
            document.querySelectorAll('.delete-entry-type-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const entryTypeId = this.dataset.id;
                    if (confirm(`Are you sure you want to delete this Entry Type? This will fail if there are any entries or relationship definitions linked to it.`)) {
                        fetch(`/api/entry_types/${entryTypeId}`, {
                            method: 'DELETE',
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                alert(data.message);
                                window.location.reload();
                            } else if (data.error) {
                                alert('Error: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An unexpected error occurred during deletion.');
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>
